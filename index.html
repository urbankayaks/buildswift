<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedTech Deals Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-hover { transition: transform 0.15s, box-shadow 0.15s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <!-- Header -->
    <header class="border-b border-slate-700 bg-slate-900/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold">ðŸ”¬ MedTech Deals Tracker</h1>
                <p class="text-slate-400 text-sm">Real-time M&A intelligence for medical technology</p>
            </div>
            <div class="flex items-center gap-3">
                <span id="lastUpdate" class="text-xs text-slate-500"></span>
                <button id="refreshBtn" onclick="refreshData()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition">
                    <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    <span id="refreshText">Refresh Data</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Stats Bar -->
        <div id="statsBar" class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6">
            <div class="bg-slate-800 rounded-lg p-3 text-center">
                <div id="statTotal" class="text-2xl font-bold text-emerald-400">-</div>
                <div class="text-xs text-slate-400">Total Deals</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-3 text-center">
                <div id="statRumored" class="text-2xl font-bold text-yellow-400">-</div>
                <div class="text-xs text-slate-400">Rumored</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-3 text-center">
                <div id="statConfirmed" class="text-2xl font-bold text-green-400">-</div>
                <div class="text-xs text-slate-400">Confirmed</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-3 text-center">
                <div id="statExploring" class="text-2xl font-bold text-orange-400">-</div>
                <div class="text-xs text-slate-400">Exploring</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-3 text-center">
                <div id="statCompleted" class="text-2xl font-bold text-blue-400">-</div>
                <div class="text-xs text-slate-400">Completed</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-3 text-center">
                <div id="statTargets" class="text-2xl font-bold text-purple-400">-</div>
                <div class="text-xs text-slate-400">Potential Targets</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-slate-800 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <div class="md:col-span-2">
                    <input id="searchInput" type="text" placeholder="Search companies, tickers, sectors..." 
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-100 placeholder-slate-400 focus:outline-none focus:border-emerald-500">
                </div>
                <select id="statusFilter" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-emerald-500">
                    <option value="">All Statuses</option>
                    <option value="rumored">Rumored</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="exploring_alternatives">Exploring Alternatives</option>
                    <option value="completed">Completed</option>
                    <option value="potential_target">Potential Target</option>
                </select>
                <select id="subsectorFilter" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-emerald-500">
                    <option value="">All Subsectors</option>
                </select>
                <div class="flex gap-2">
                    <input id="minCap" type="number" placeholder="Min $B" step="0.1" min="0"
                           class="w-1/2 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-100 placeholder-slate-400 focus:outline-none focus:border-emerald-500">
                    <input id="maxCap" type="number" placeholder="Max $B" step="0.1" min="0"
                           class="w-1/2 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-100 placeholder-slate-400 focus:outline-none focus:border-emerald-500">
                </div>
            </div>
        </div>

        <!-- Results count -->
        <div class="flex items-center justify-between mb-4">
            <p id="resultCount" class="text-sm text-slate-400"></p>
            <select id="sortSelect" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-xs text-slate-300 focus:outline-none">
                <option value="last_updated">Latest Updated</option>
                <option value="first_seen">Newest Found</option>
                <option value="market_cap_b">Market Cap</option>
                <option value="name">Name</option>
            </select>
        </div>

        <!-- Deal Cards -->
        <div id="dealsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="col-span-full text-center py-12 text-slate-500">
                <p class="text-lg">Loading deals...</p>
                <p class="text-sm mt-1">Hit "Refresh Data" to pull from live sources</p>
            </div>
        </div>
    </main>

    <script>
        // Static mode: load all deals once, filter client-side
        // Live mode: hit API endpoints
        const STATIC_MODE = typeof STATIC_DEPLOY !== 'undefined' ? STATIC_DEPLOY : !window.location.port;
        let ALL_DEALS = [];

        const STATUS_STYLES = {
            rumored: { bg: 'bg-yellow-500/20', text: 'text-yellow-400', label: 'Rumored' },
            confirmed: { bg: 'bg-green-500/20', text: 'text-green-400', label: 'Confirmed' },
            exploring_alternatives: { bg: 'bg-orange-500/20', text: 'text-orange-400', label: 'Exploring' },
            completed: { bg: 'bg-blue-500/20', text: 'text-blue-400', label: 'Completed' },
            potential_target: { bg: 'bg-purple-500/20', text: 'text-purple-400', label: 'Potential Target' },
        };

        const DEAL_TYPE_LABELS = {
            acquisition: 'ðŸ¤ Acquisition',
            merger: 'ðŸ”„ Merger',
            divestiture: 'âœ‚ï¸ Divestiture',
            ipo_spinoff: 'ðŸš€ IPO/Spin-off',
        };

        let debounceTimer;

        // Load all data (static or live)
        async function loadAllData() {
            try {
                if (STATIC_MODE) {
                    const res = await fetch('api/deals.json');
                    const data = await res.json();
                    ALL_DEALS = data.deals || [];
                } else {
                    const res = await fetch('/api/deals?limit=500');
                    const data = await res.json();
                    ALL_DEALS = data.deals || [];
                }
            } catch (e) {
                console.error('Load error:', e);
            }
            computeStatsAndRender();
        }

        // Client-side filtering
        function getFilteredDeals() {
            const q = document.getElementById('searchInput').value.trim().toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const subsector = document.getElementById('subsectorFilter').value;
            const minCap = parseFloat(document.getElementById('minCap').value) || null;
            const maxCap = parseFloat(document.getElementById('maxCap').value) || null;
            const sort = document.getElementById('sortSelect').value;

            let filtered = ALL_DEALS.filter(d => {
                if (q && !(`${d.name} ${d.ticker || ''} ${d.subsector || ''} ${d.summary || ''}`).toLowerCase().includes(q)) return false;
                if (status && d.deal_status !== status) return false;
                if (subsector && d.subsector !== subsector) return false;
                if (minCap && (!d.market_cap_b || d.market_cap_b < minCap)) return false;
                if (maxCap && (!d.market_cap_b || d.market_cap_b > maxCap)) return false;
                return true;
            });

            filtered.sort((a, b) => {
                if (sort === 'name') return (a.name || '').localeCompare(b.name || '');
                if (sort === 'market_cap_b') return (b.market_cap_b || 0) - (a.market_cap_b || 0);
                return (b[sort] || '').localeCompare(a[sort] || '');
            });

            return filtered;
        }

        function fetchDeals() {
            const filtered = getFilteredDeals();
            renderDeals(filtered);
            document.getElementById('resultCount').textContent = `${filtered.length} deal${filtered.length !== 1 ? 's' : ''} found`;
        }

        function computeStatsAndRender() {
            const byStatus = {};
            const bySubsector = {};
            ALL_DEALS.forEach(d => {
                const s = d.deal_status || 'Unknown';
                const ss = d.subsector || 'Unknown';
                byStatus[s] = (byStatus[s] || 0) + 1;
                bySubsector[ss] = (bySubsector[ss] || 0) + 1;
            });

            document.getElementById('statTotal').textContent = ALL_DEALS.length;
            document.getElementById('statRumored').textContent = byStatus.rumored || 0;
            document.getElementById('statConfirmed').textContent = byStatus.confirmed || 0;
            document.getElementById('statExploring').textContent = byStatus.exploring_alternatives || 0;
            document.getElementById('statCompleted').textContent = byStatus.completed || 0;
            document.getElementById('statTargets').textContent = byStatus.potential_target || 0;

            const sel = document.getElementById('subsectorFilter');
            const current = sel.value;
            sel.innerHTML = '<option value="">All Subsectors</option>';
            Object.keys(bySubsector).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = `${s} (${bySubsector[s]})`;
                sel.appendChild(opt);
            });
            sel.value = current;

            fetchDeals();
        }

        async function fetchStats() { /* stats computed client-side now */ }

        // Render deal cards
        function renderDeals(deals) {
            const grid = document.getElementById('dealsGrid');
            if (!deals || deals.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-slate-500">
                        <p class="text-lg">No deals found</p>
                        <p class="text-sm mt-1">Try adjusting filters or hit "Refresh Data" to pull from live sources</p>
                    </div>`;
                return;
            }

            grid.innerHTML = deals.map(deal => {
                const st = STATUS_STYLES[deal.deal_status] || STATUS_STYLES.rumored;
                const dt = DEAL_TYPE_LABELS[deal.deal_type] || deal.deal_type;
                const capStr = deal.market_cap_b ? `$${deal.market_cap_b}B` : '';
                const tickerBadge = deal.ticker ? `<span class="bg-slate-600 text-slate-300 text-xs px-2 py-0.5 rounded">${deal.ticker}</span>` : '';
                const updated = deal.last_updated ? new Date(deal.last_updated).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

                return `
                <div class="bg-slate-800 rounded-lg p-4 card-hover border border-slate-700">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold text-base leading-tight flex-1 mr-2">${escHtml(deal.name)}</h3>
                        ${tickerBadge}
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-3">
                        <span class="${st.bg} ${st.text} text-xs px-2 py-0.5 rounded-full font-medium">${st.label}</span>
                        <span class="bg-slate-700 text-slate-300 text-xs px-2 py-0.5 rounded-full">${dt}</span>
                        ${deal.subsector ? `<span class="bg-emerald-500/15 text-emerald-400 text-xs px-2 py-0.5 rounded-full">${escHtml(deal.subsector)}</span>` : ''}
                        ${capStr ? `<span class="bg-slate-700 text-slate-200 text-xs px-2 py-0.5 rounded-full font-medium">${capStr}</span>` : ''}
                    </div>
                    <p class="text-sm text-slate-400 truncate-2 mb-3">${escHtml(deal.summary || '')}</p>
                    <div class="flex items-center justify-between text-xs text-slate-500">
                        <span>${updated}</span>
                        ${deal.source_url ? `<a href="${escHtml(deal.source_url)}" target="_blank" class="text-emerald-400 hover:text-emerald-300">${escHtml(deal.source_name || 'Source')} â†—</a>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function escHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // Refresh
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            const txt = document.getElementById('refreshText');
            btn.disabled = true;
            icon.classList.add('spinner');
            txt.textContent = 'Refreshing...';

            try {
                if (!STATIC_MODE) {
                    await fetch('/api/refresh', { method: 'POST' });
                    await new Promise(r => setTimeout(r, 8000));
                }
                await loadAllData();
                document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
            } catch (e) {
                console.error('Refresh error:', e);
            } finally {
                btn.disabled = false;
                icon.classList.remove('spinner');
                txt.textContent = 'Refresh Data';
            }
        }

        // Debounced search
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(fetchDeals, 300);
        });

        // Filter change listeners
        ['statusFilter', 'subsectorFilter', 'sortSelect'].forEach(id => {
            document.getElementById(id).addEventListener('change', fetchDeals);
        });
        ['minCap', 'maxCap'].forEach(id => {
            document.getElementById(id).addEventListener('change', fetchDeals);
        });

        // Auto-refresh every 60s (live mode only)
        if (!STATIC_MODE) {
            setInterval(() => { loadAllData(); }, 60000);
        }

        // Init
        loadAllData();
    </script>
</body>
</html>
